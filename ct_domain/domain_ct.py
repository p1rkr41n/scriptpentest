from crtsh import crtshAPI
import sys
# python3 domain_ct.py domain
def get_links(domain):
    lister = crtshAPI().search(domain)
    fixlist =[]
    lastlist = []
    for line in lister:
            fixlist.extend( line["common_name"])
            fixlist.extend(line["name_value"].split("\n"))
    fixlist = set(fixlist)
    fixlist = list(fixlist)
    fixlist = sorted(fixlist)

    for lining in fixlist:
        if domain in lining:
            if '*' in lining:
                continue
            elif "www" in lining:
                lining.lstrip("www.")
                # print(lining.replace("www.", ""))
                lastlist.append(lining)
            else:
                # print(lining)
                lastlist.append(lining.replace("www.", ""))
    # print(len(lastlist))
    if len(lastlist) == 1:
        return []
    else:
        # lastlist= set(lastlist)
        return lastlist



if __name__ == "__main__":
    # Deep scan all subdomain use https (certificate transparency reported)
    # get start
    try:
        domain = sys.argv[1]
    except :
        print("Scanning example.com...")
        domain = "example.com"
    domainlist = [{"name":domain,"type":0}]

    # In for =))
    for link in domainlist:
        # print(link["name"])
        print("Processing domain: " + link["name"] + " " + str(domainlist.index(link)) + "/" + str(len(domainlist)-1))
        if link["type"] == 0:
            templist = get_links(link["name"])
        #update status link:
            link["type"] = 1
        # check and update domainlist status
        for line in templist:
            if {"name":line,"type":0} in domainlist or {"name":line,"type":1} in domainlist:
                continue
            else:
                domainlist.append({"name":line,"type":0})
    for domain in domainlist:
        print(domain["name"])
